<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RecFacialJS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link rel="stylesheet" href="/styles/style.css"/>
</head>
<body class="blue-grey darken-4">
    <div class="container">
        <div class="card">
            <div class="card-content">
                <h4 class="blue-grey-text text-darken-4">Escanear</h4>

                <div class="input-field">
                    <input id="username" autofocus required placeholder="Informe seu nome aqui"/>
                    <span class="helper-text" data-error="Campo obrigatório" data-success="">
                        Esse é o nome que vai aparecer quando seu rosto for detectado na página detectar
                    </span>
                </div>

                <div class="media-container">
                    <video id="video" autoplay muted class="responsive-video"></video>
                    <canvas/>
                </div>
            </div>

            <div class="card-action">
                <button id="btn-save" class="btn waves-effect waves-light" disabled>
                    Salvar Dados
                </button>

                <button id="btn-users" class="btn orange waves-effect waves-light">
                    Ver Usuários
                </button>
            </div>
        </div>

        <div id="users" class="modal">
            <div class="modal-content">
                <h4>Usuários</h4>

                <table class="striped centered responsive-table">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Registros</th>
                            <th>Opções</th>
                        </tr>
                    </thead>

                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="/scripts/face-api.min.js"></script>
    <script src="/scripts/setup.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const recFacial = new RecFacial();

            const btnSave = document.querySelector("button#btn-save");
            const btnUsers = document.querySelector("button#btn-users");

            const inputUsername = document.querySelector("input#username");

            recFacial.handleDetect = () => {
                btnSave.removeAttribute("disabled");
            };

            btnSave.addEventListener("click", () => {
                inputUsername.classList.remove("invalid");
                
                const username = String(inputUsername.value).trim();
                
                if(!username) {
                    inputUsername.focus();
                    inputUsername.classList.add("invalid");
                }
                
                recFacial.saveDescriptor(username);
                
                M.Toast.dismissAll();

                M.toast({
                    html: "Salvo com sucesso",
                    classes: "rounded green",
                });
            });

            btnUsers.addEventListener("click", () => {
                const modal = document.querySelector(".modal#users");
                const tBody = modal.querySelector("table tbody");

                const {
                    labels = [],
                    descriptors = [],
                } = recFacial.setFaceMatcher() || {};

                tBody.innerHTML = "";

                labels.forEach((label, index) => {
                    const currentUserDescriptors = descriptors[index];
                    const numDescriptors = currentUserDescriptors.length;

                    const tr = document.createElement("tr");
                    const tdRemove = document.createElement("td");
                    const btnRemove = document.createElement("button");

                    btnRemove.innerText = "Remover";
                    btnRemove.classList.add("btn", "red", "waves-effect", "waves-light");

                    btnRemove.addEventListener("click", () => {
                        recFacial.removeUser(label);
                        document.querySelector(`tbody tr:nth-child(${index + 1})`).classList.add("hide");
                    });

                    tr.innerHTML = `
                        <td>${label}</td>
                        <td>${numDescriptors}</td>
                    `;

                    tdRemove.appendChild(btnRemove);
                    tr.appendChild(tdRemove);

                    tBody.appendChild(tr);
                });

                modal.M_Modal?.open();
            });

            M.AutoInit();
        });
    </script>
</body>
</html>
